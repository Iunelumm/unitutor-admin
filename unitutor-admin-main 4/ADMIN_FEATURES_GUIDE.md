# UniTutor 管理员面板 - 功能使用指南

## 🎉 新增功能概览

本次更新添加了强大的管理功能，让你可以完全控制平台运营。

### ✅ 已实现的功能

1. **💬 工单回复系统** - 直接回复用户工单并更新状态
2. **👥 优化用户角色显示** - 显示 student/tutor/both 而不是 user/admin
3. **📋 用户详细信息页面** - 查看用户完整统计数据
4. **🗑️ 用户删除功能** - 删除违规用户（软删除）
5. **🎯 管理员评分系统** - 50% 权重的管理员评分

---

## 📖 功能详细说明

### 1. 💬 支持工单管理

#### 查看工单
- 进入"💬 支持工单"页面
- 可以按状态筛选：待处理、处理中、已解决
- 表格显示所有工单信息

#### 回复工单
1. 在工单列表下方找到"📝 回复工单"部分
2. 输入工单 ID
3. 查看工单详情（自动展开）
4. 在文本框中输入回复内容
5. 选择新的工单状态
6. 点击"💾 提交回复"

**示例流程**:
```
1. 用户提交工单 #123
2. 管理员查看工单详情
3. 输入回复："您的问题已处理，请重新登录尝试"
4. 将状态从 "pending" 改为 "resolved"
5. 提交回复
6. 用户在前端可以看到管理员回复
```

---

### 2. 👥 用户管理优化

#### 角色筛选
- **学生**: 只学习的用户
- **教师**: 只教学的用户
- **两者都是**: 既学习又教学的用户

#### 查看用户详细信息

**步骤**:
1. 在用户管理页面，找到"📋 查看用户详细信息"
2. 输入用户 ID
3. 点击"查看详情"

**显示内容**:

##### 基本信息
- 姓名、邮箱
- 角色（student/tutor/both）
- 登录方式
- 注册时间、最后登录时间

##### 个人资料
- 专业、年级
- 价格范围（教师）
- 积分
- 个人简介

##### 会话统计
**作为学生**:
- 总会话数
- 已完成数量
- 已取消数量
- 有争议数量

**作为教师**:
- 总会话数
- 已完成数量
- 已取消数量
- 有争议数量

##### 评分统计
- 平均评分
- 评分数量

##### 最近会话
- 最近 10 个会话记录
- 显示对方姓名、课程、状态

**使用场景**:
- 用户投诉时查看其历史记录
- 评估用户信誉
- 决定是否需要处罚

---

### 3. 🗑️ 删除用户功能

#### 何时使用
- 用户严重违规
- 用户恶意取消课程
- 用户发布不当内容
- 用户要求删除账户

#### 删除流程
1. 在用户管理页面输入用户 ID
2. 点击"🗑️ 删除用户"
3. 查看警告信息
4. 点击"✅ 确认删除"

#### 删除效果（软删除）
- ✅ 用户名改为"已删除用户_[ID]"
- ✅ 邮箱改为"deleted_[ID]@deleted.com"
- ✅ 用户无法再登录
- ✅ 历史数据保留（用于审计）
- ✅ 不影响其他用户的会话记录

**注意**: 这是**软删除**，数据不会真正从数据库中删除，只是标记为已删除。

---

### 4. 🎯 管理员评分系统（50% 权重）

#### 评分机制

**最终评分计算公式**:
```
最终评分 = 管理员评分 × 50% + 用户平均评分 × 50%
```

**示例**:
- 用户平均评分: 4.0
- 管理员评分: 2.0
- 最终评分: 2.0 × 0.5 + 4.0 × 0.5 = **3.0**

#### 使用流程

##### 步骤 1: 选择用户
进入"🎯 管理员评分"页面，有两种方式选择用户：

**方式 A**: 搜索用户
- 输入姓名或邮箱
- 从搜索结果中查看用户 ID

**方式 B**: 直接输入 ID
- 在"或直接输入用户 ID"框中输入

##### 步骤 2: 查看当前评分
系统会显示：
- **用户平均评分**: 其他用户给的平均分
- **管理员评分**: 你之前给的评分（如果有）
- **最终加权评分**: 按 50/50 计算的最终分数

##### 步骤 3: 提交评分
1. 使用滑块选择评分（1-5）
2. 输入评价说明（可选但建议填写）
3. 点击"💾 提交管理员评分"

##### 步骤 4: 查看所有评分
页面下方显示所有管理员评分记录

#### 使用场景

**场景 1: 奖励优秀用户**
- 用户表现优秀但评分不高
- 给予 5 分管理员评分提升其总分

**场景 2: 惩罚违规用户**
- 用户有违规行为
- 给予 1-2 分管理员评分降低其总分

**场景 3: 调整不公平评分**
- 用户被恶意差评
- 给予合理的管理员评分平衡总分

**场景 4: 新用户扶持**
- 新教师还没有评分
- 给予初始管理员评分帮助其获得信任

#### 评分建议

| 评分 | 说明 | 使用场景 |
|------|------|----------|
| 5 分 | 优秀 | 表现卓越，值得推荐 |
| 4 分 | 良好 | 表现不错，可以信任 |
| 3 分 | 一般 | 中规中矩，无明显问题 |
| 2 分 | 较差 | 有一些问题，需要改进 |
| 1 分 | 很差 | 严重问题，不推荐使用 |

---

## 🔄 工作流程示例

### 示例 1: 处理用户投诉

**场景**: 学生投诉教师 #456 课程质量差

**流程**:
1. 进入"💬 支持工单"查看投诉详情
2. 进入"👥 用户管理"，输入教师 ID #456
3. 点击"查看详情"，查看：
   - 该教师的历史会话数
   - 取消率
   - 平均评分
   - 最近会话记录
4. 如果确认问题严重：
   - 进入"🎯 管理员评分"
   - 给予 2 分管理员评分
   - 说明："多次投诉，课程质量需改进"
5. 回到"💬 支持工单"
   - 回复学生："已处理，该教师已被警告"
   - 更新状态为"已解决"

### 示例 2: 删除恶意用户

**场景**: 用户 #789 恶意取消多个课程

**流程**:
1. 进入"👥 用户管理"，输入 #789
2. 点击"查看详情"，确认：
   - 取消率超过 50%
   - 有多个争议会话
3. 点击"🗑️ 删除用户"
4. 确认删除
5. 用户被标记为"已删除用户_789"

### 示例 3: 扶持新教师

**场景**: 新教师 #234 刚注册，还没有评分

**流程**:
1. 进入"🎯 管理员评分"
2. 输入用户 ID #234
3. 查看其资料确认资质良好
4. 给予 4 分管理员评分
5. 说明："新教师，资质审核通过"
6. 这样新教师的初始评分为 2.0（4 × 0.5 + 0 × 0.5）

---

## 📊 数据库变更

### 新增表: adminRatings

管理员评分系统会自动创建此表：

```sql
CREATE TABLE adminRatings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    targetUserId INT NOT NULL,
    score INT NOT NULL,
    comment TEXT,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_target (targetUserId)
);
```

**字段说明**:
- `targetUserId`: 被评分的用户 ID（唯一，每个用户只能有一个管理员评分）
- `score`: 评分 1-5
- `comment`: 评价说明
- `createdAt`: 创建时间
- `updatedAt`: 最后更新时间

**注意**: 
- 每个用户只能有一个管理员评分
- 重复评分会更新现有记录
- 表会在首次访问"🎯 管理员评分"页面时自动创建

---

## ⚠️ 注意事项

### 权限管理
- 所有功能都需要管理员密码才能访问
- 不要分享管理员密码
- 定期更换密码

### 数据安全
- 删除用户是软删除，数据不会丢失
- 所有操作都有时间戳记录
- 建议定期备份数据库

### 评分公平性
- 管理员评分权重很大（50%），请谨慎使用
- 建议记录评分原因
- 定期审查管理员评分是否合理

### 性能优化
- 用户详情页面查询较多，加载可能稍慢
- 建议只在需要时查看详情
- 大量操作后可能需要刷新页面

---

## 🐛 常见问题

### Q1: 工单回复后用户看不到？
**A**: 确保：
1. 回复已成功提交（有成功提示）
2. 工单状态已更新
3. 用户刷新了前端页面

### Q2: 删除用户后还能看到？
**A**: 这是正常的，软删除只是标记用户，数据仍在数据库中。用户名会变成"已删除用户_[ID]"。

### Q3: 管理员评分不生效？
**A**: 检查：
1. 评分是否成功提交
2. 刷新页面查看最新评分
3. 确认 adminRatings 表已创建

### Q4: 用户详情加载慢？
**A**: 这是正常的，因为需要查询多个表。如果太慢：
1. 检查数据库连接
2. 确认 Railway 数据库状态正常
3. 考虑添加数据库索引

### Q5: 如何撤销删除用户？
**A**: 需要手动在数据库中恢复：
```sql
UPDATE users 
SET name = '原始姓名', email = '原始邮箱'
WHERE id = [用户ID];
```

---

## 🚀 部署更新

### 更新步骤

```bash
# 1. 更新代码
git add app.py
git commit -m "Add enhanced admin features"
git push origin main

# 2. Streamlit Cloud 会自动检测并重新部署

# 3. 等待 2-3 分钟

# 4. 刷新管理员面板页面
```

### 验证功能

部署后测试：
1. ✅ 工单回复功能正常
2. ✅ 用户详情可以查看
3. ✅ 删除用户功能正常
4. ✅ 管理员评分可以提交
5. ✅ 加权评分计算正确

---

## 📞 技术支持

如果遇到问题：
1. 查看 Streamlit Cloud 日志
2. 检查数据库连接状态
3. 确认 adminRatings 表已创建
4. 查看浏览器控制台错误

---

**版本**: v2.0 Enhanced
**更新日期**: 2024-11-08
**作者**: Manus AI
